<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Impression √©tiquettes QR ‚Äî Envie Nord</title>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --envie-green:#009640;
      --envie-green-dark:#006B2D;
      --envie-bg:#F5F5F5;
      --envie-white:#FFFFFF;
      --border:#E5E5E5;

      --page-margin: 0mm;
      --gap: 0mm;
      --label-radius: 0mm;
    }

    body{
      margin:20px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--envie-bg);
      color:#333;
    }

    a{ color:var(--envie-green); font-weight:800; text-decoration:none; }
    .topbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 16px; background:#fff;
      border:1px solid var(--border); border-radius:18px;
      max-width:1100px;
    }
    .brand{ font-weight:900; color:var(--envie-green-dark); }

    .panel{
      margin-top:14px; padding:14px 16px;
      background:#fff; border:1px solid var(--border);
      border-radius:18px; max-width:1100px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label{ font-size:12px; font-weight:800; color:#666; display:block; margin-bottom:6px; }
    input,select{
      padding:12px 14px; border-radius:14px;
      border:1px solid var(--border); background:#fff;
      min-width:200px;
    }

    .btn{
      padding:12px 18px; border-radius:14px;
      border:2px solid var(--envie-green);
      background:#fff; color:var(--envie-green);
      font-weight:900; cursor:pointer;
    }
    .btn:hover{ background:var(--envie-green); color:#fff; }
    .btn-muted{ border-color:#bbb; color:#444; }

    .sheet{
      margin-top:14px; background:#fff;
      border:1px solid var(--border);
      border-radius:18px; padding:14px 16px;
      max-width:1100px;
    }

    .page{
      width:210mm; height:297mm;
      padding:var(--page-margin);
      box-sizing:border-box;
      overflow:hidden;
    }

    .grid{
      display:grid;
      width:100%; height:100%;
      grid-template-columns:1fr 1fr;
      grid-template-rows:repeat(8,minmax(0,1fr));
      gap:var(--gap);
    }

    .label{
      border:1px solid #ddd;
      padding:5mm 4mm;
      display:flex; justify-content:space-between;
      align-items:center;
      box-sizing:border-box;
      overflow:hidden;
    }

    .label-empty{
      border:1px dashed #ccc;
      background:#fafafa;
    }

    .txt .m{ font-weight:900; font-size:12pt; color:var(--envie-green-dark); }
    .txt .mo{ font-weight:800; font-size:11pt; }
    .txt .c{ font-size:9pt; color:#555; }

    .qr{ width:28mm; height:28mm; }

    .table{ width:100%; border-collapse:collapse; }
    .table th,.table td{ border-bottom:1px solid #eee; padding:8px; }
    .table th{ text-align:left; font-weight:900; color:#555; }

    .qtywrap{ display:flex; gap:6px; }
    .smallbtn{ width:32px; height:32px; border-radius:8px; border:1px solid #ccc; cursor:pointer; }

    @media print{
      body{ margin:0; background:#fff; }
      .topbar,.panel{ display:none; }
      @page{ size:A4; margin:0; }
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="brand">Envie Nord ‚Äî √âtiquettes QR</div>
  <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimer</button>
</div>

<div class="panel">
  <div class="row">
    <div><label>Recherche</label><input id="q"></div>
    <div><label>Cat√©gorie</label><select id="cat"><option value="">Toutes</option></select></div>
    <div><label>√âtiquettes vierges au d√©but</label><input id="offset" type="number" min="0" max="15" value="0"></div>
    <div>
      <button class="btn" id="generateBtn">G√©n√©rer</button>
      <button class="btn btn-muted" id="clearBtn">Vider</button>
    </div>
  </div>
  <p id="count"></p>
  <div id="picklist"></div>
</div>

<div class="sheet">
  <div id="pages"></div>
</div>

<script>
const SUPABASE_URL = "https://ybepaugrwnlpdewzqdzp.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Dy87RVWNEBzT-sxScuSr1A_kUflkc4a";

let ALL=[], QTY={};

const pagesEl=document.getElementById("pages");
const countEl=document.getElementById("count");

const esc=s=>(""+(s||"")).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));

async function api(q){
  const r=await fetch(SUPABASE_URL+q,{headers:{apikey:SUPABASE_ANON_KEY,Authorization:"Bearer "+SUPABASE_ANON_KEY}});
  return r.json();
}

function buildUrl(slug){
  return location.origin+location.pathname.replace(/\/print.*/,"/machines/?slug="+encodeURIComponent(slug));
}

function renderPicker(){
  const q=document.getElementById("q").value.toLowerCase();
  const cat=document.getElementById("cat").value;
  let f=ALL.filter(m=>(!cat||m.categorie===cat)&&(`${m.marque} ${m.modele}`.toLowerCase().includes(q)));

  countEl.textContent=`${f.length} mod√®les ‚Äî ${Object.values(QTY).reduce((a,b)=>a+b,0)} √©tiquettes`;

  document.getElementById("picklist").innerHTML=`
    <table class="table">
      <thead><tr><th>Mod√®le</th><th>Qt√©</th></tr></thead>
      <tbody>${f.map(m=>`
        <tr>
          <td><strong>${esc(m.marque)}</strong><br>${esc(m.modele)}</td>
          <td><input type="number" min="0" value="${QTY[m.slug]||0}"
            onchange="QTY['${m.slug}']=+this.value||0"></td>
        </tr>`).join("")}
      </tbody>
    </table>`;
}

function generate(){
  pagesEl.innerHTML="";
  let list=[];
  Object.entries(QTY).forEach(([s,q])=>{
    const m=ALL.find(x=>x.slug===s);
    for(let i=0;i<q;i++) list.push(m);
  });

  let offset=+document.getElementById("offset").value||0;
  let i=0, grid;

  for(let k=0;k<offset;k++){
    if(i%16===0){ grid=newPage(); }
    addEmpty(grid); i++;
  }
  list.forEach(m=>{
    if(i%16===0){ grid=newPage(); }
    addLabel(grid,m); i++;
  });
}

function newPage(){
  const p=document.createElement("div");
  p.className="page";
  const g=document.createElement("div");
  g.className="grid";
  p.appendChild(g); pagesEl.appendChild(p);
  return g;
}

function addEmpty(g){
  const d=document.createElement("div");
  d.className="label label-empty";
  g.appendChild(d);
}

function addLabel(g,m){
  const d=document.createElement("div");
  d.className="label";
  d.innerHTML=`<div class="txt">
    <div class="m">${esc(m.marque)}</div>
    <div class="mo">${esc(m.modele)}</div>
    <div class="c">${esc(m.categorie)}</div>
  </div><div class="qr"></div>`;
  g.appendChild(d);
  new QRCode(d.querySelector(".qr"),{text:buildUrl(m.slug),width:96,height:96,correctLevel:QRCode.CorrectLevel.H});
}

document.getElementById("generateBtn").onclick=generate;
document.getElementById("clearBtn").onclick=()=>{QTY={};renderPicker();pagesEl.innerHTML="";};
document.getElementById("q").oninput=renderPicker;
document.getElementById("cat").onchange=renderPicker;

(async()=>{
  ALL=await api("/rest/v1/machines?select=categorie,marque,modele,slug");
  [...new Set(ALL.map(x=>x.categorie))].forEach(c=>{
    document.getElementById("cat").innerHTML+=`<option>${esc(c)}</option>`;
  });
  renderPicker();
})();
</script>

</body>
</html>
