<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machines</title>
</head>

<body style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; line-height: 1.4;">
  <a href="../">‚Üê Accueil</a>
  <h1 id="title">Machines</h1>
  <div id="content">Chargement‚Ä¶</div>

  <script>
    // ‚úÖ REMPLACEZ ICI
    const SUPABASE_URL = "https://ybepaugrwnlpdewzqdzp.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Dy87RVWNEBzT-sxScuSr1A_kUflkc4a";

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function badge(text) {
      const t = (text || "").trim();
      if (!t) return "";
      return `<span style="display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px">${escapeHtml(t)}</span>`;
    }

    function linkButton(url, label) {
      const u = (url || "").trim();
      if (!u) return `<span style="opacity:.6">${escapeHtml(label)} : bient√¥t disponible</span>`;
      return `<a href="${escapeHtml(u)}" target="_blank" rel="noopener"
                style="display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:10px;text-decoration:none">
                ${escapeHtml(label)}
              </a>`;
    }

    async function supabaseGet(pathWithQuery) {
      const res = await fetch(`${SUPABASE_URL}${pathWithQuery}`, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`Supabase error (${res.status}) ${txt}`);
      }
      return await res.json();
    }

    async function loadList() {
      return await supabaseGet(
        "/rest/v1/machines?select=categorie,marque,modele,notice_pdf,fiche_technique_pdf,statut,slug&order=marque.asc,modele.asc"
      );
    }

    async function loadOneBySlug(slug) {
      const data = await supabaseGet(
        `/rest/v1/machines?select=categorie,marque,modele,notice_pdf,fiche_technique_pdf,statut,slug&slug=eq.${encodeURIComponent(slug)}&limit=1`
      );
      return data[0] || null;
    }

    function renderList(items) {
      document.getElementById("title").textContent = "Liste des mod√®les";

      const rows = (items || []).map(it => {
        const slug = it.slug || "";
        const url = `./?slug=${encodeURIComponent(slug)}`;
        return `
          <div style="padding:14px 0;border-bottom:1px solid #eee">
            <div style="font-weight:600">${escapeHtml(it.marque)} ‚Äì ${escapeHtml(it.modele)}</div>
            <div style="margin:6px 0; color:#444">
              ${escapeHtml(it.categorie || "")}
              ${it.statut ? " ¬∑ " + badge(it.statut) : ""}
            </div>
            <div><a href="${url}">Voir la page mod√®le</a></div>
          </div>
        `;
      }).join("");

      document.getElementById("content").innerHTML = `
        <p style="color:#444">Astuce QR : utilisez <code>?slug=...</code> (ex: <code>?slug=bosch-wat28409fr</code>).</p>
        <div style="margin-top:12px;border-top:1px solid #eee">
          ${rows || "<p>Aucun mod√®le.</p>"}
        </div>
      `;
    }

    function renderModel(model) {
      const title = `${model.marque || ""} ‚Äì ${model.modele || ""}`.trim() || "Mod√®le";
      document.getElementById("title").textContent = title;

      const notice = model.notice_pdf || "";
      const fiche  = model.fiche_technique_pdf || "";

      document.getElementById("content").innerHTML = `
        <p><a href="./">‚Üê Retour √† la liste</a></p>

        <div style="padding:16px;border:1px solid #eee;border-radius:16px;max-width:720px">
          <div style="color:#444;margin-bottom:8px">${escapeHtml(model.categorie || "")}</div>
          <div style="margin-bottom:10px">${model.statut ? badge(model.statut) : ""}</div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin:12px 0">
            ${linkButton(notice, "üìÑ Notice PDF")}
            ${linkButton(fiche,  "üìä Fiche technique PDF")}
          </div>

          <div style="margin-top:10px;color:#555;font-size:14px">
            <div><strong>Marque :</strong> ${escapeHtml(model.marque || "")}</div>
            <div><strong>Mod√®le :</strong> ${escapeHtml(model.modele || "")}</div>
            <div><strong>Slug :</strong> ${escapeHtml(model.slug || "")}</div>
          </div>
        </div>
      `;
    }

    (async () => {
      try {
        const slug = (getParam("slug") || "").trim();
        if (!slug) {
          const items = await loadList();
          renderList(items);
          return;
        }

        const model = await loadOneBySlug(slug);
        if (!model) {
          document.getElementById("title").textContent = "Mod√®le introuvable";
          document.getElementById("content").innerHTML = `
            <p>Le mod√®le <code>${escapeHtml(slug)}</code> n‚Äôexiste pas (ou le slug ne correspond pas).</p>
            <p><a href="./">Retour √† la liste</a></p>
          `;
          return;
        }

        renderModel(model);
      } catch (e) {
        document.getElementById("content").innerHTML = `
          <p style="color:#b00"><strong>Erreur :</strong> ${escapeHtml(e.message || String(e))}</p>
          <p>V√©rifiez :</p>
          <ul>
            <li>SUPABASE_URL et SUPABASE_ANON_KEY</li>
            <li>RLS activ√© + policy SELECT pour <code>anon</code></li>
            <li>la table s'appelle bien <code>machines</code> et contient des lignes</li>
          </ul>
        `;
      }
    })();
  </script>
</body>
</html>
