<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machines ‚Äì Envie Nord</title>

  <style>
    :root{
      --envie-green:#009640;
      --envie-green-dark:#006B2D;
      --envie-green-light:#E6F4EC;
      --envie-text:#333333;
      --envie-bg:#F5F5F5;
      --envie-white:#FFFFFF;
      --border:#E5E5E5;
    }
    body{
      margin:24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--envie-bg);
      color:var(--envie-text);
      line-height:1.4;
    }
    a{ color:var(--envie-green); text-decoration:none; font-weight:600; }
    a:hover{ text-decoration:underline; }
    h1{ color:var(--envie-green-dark); margin:12px 0 16px; }
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px; background:var(--envie-white);
      border:1px solid var(--border); border-radius:18px;
    }
    .brand{
      font-weight:800; color:var(--envie-green-dark);
      letter-spacing:.2px;
    }
    .card{
      background:var(--envie-white);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      max-width:820px;
    }
    .list-item{
      padding:14px 0;
      border-bottom:1px solid #eee;
    }
    .title{
      font-weight:800;
    }
    .meta{
      margin:6px 0; color:#444;
    }
    .badge{
      display:inline-block;
      padding:4px 12px;
      border-radius:999px;
      background:var(--envie-green-light);
      color:var(--envie-green-dark);
      font-size:12px;
      font-weight:800;
      border:1px solid #cfe8da;
    }
    .btn{
      display:inline-block;
      padding:10px 16px;
      border-radius:12px;
      border:1px solid var(--envie-green);
      color:var(--envie-green);
      background:var(--envie-white);
      font-weight:800;
    }
    .btn:hover{
      background:var(--envie-green);
      color:var(--envie-white);
      text-decoration:none;
    }
    .btn-disabled{
      opacity:.6;
      border-color:#ccc;
      color:#666;
      background:#fafafa;
      cursor:default;
    }
    code{ background:#fff; border:1px solid var(--border); padding:2px 6px; border-radius:8px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="topbar">
    <a href="../">‚Üê Accueil</a>
    <div class="brand">Envie Nord ‚Äî Notices & Fiches techniques</div>
  </div>

  <h1 id="title">Machines</h1>

  <div id="content" class="card">Chargement‚Ä¶</div>

  <script>
    // ‚úÖ Remplacez avec vos infos Supabase
    const SUPABASE_URL = "https://ybepaugrwnlpdewzqdzp.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Dy87RVWNEBzT-sxScuSr1A_kUflkc4a";

    // ‚úÖ Petit garde-fou: si le script tourne, on change imm√©diatement le texte
    const contentEl = document.getElementById("content");
    contentEl.textContent = "Connexion‚Ä¶";

    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalizeText(s) {
  return (s ?? "").toString()
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu, ""); // enl√®ve accents
}

function uniqueSorted(values) {
  const set = new Set(values.filter(Boolean));
  return Array.from(set).sort((a,b) => a.localeCompare(b, "fr", { sensitivity: "base" }));
}

    function badge(text) {
      const t = (text || "").trim();
      if (!t) return "";
      return '<span class="badge">' + escapeHtml(t) + '</span>';
    }

    function linkButton(url, label) {
      const u = (url || "").trim();
      if (!u) return '<span class="btn btn-disabled">' + escapeHtml(label) + ' : bient√¥t disponible</span>';
      return '<a class="btn" href="' + escapeHtml(u) + '" target="_blank" rel="noopener">' + escapeHtml(label) + '</a>';
    }

    async function supabaseGet(pathWithQuery) {
      const res = await fetch(SUPABASE_URL + pathWithQuery, {
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: "Bearer " + SUPABASE_ANON_KEY,
        },
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error("Supabase (" + res.status + ") " + txt);
      }
      return await res.json();
    }

    async function loadList() {
      return await supabaseGet(
        "/rest/v1/machines?select=categorie,marque,modele,notice_pdf,fiche_technique_pdf,statut,slug&order=marque.asc,modele.asc"
      );
    }

    async function loadOneBySlug(slug) {
      const data = await supabaseGet(
        "/rest/v1/machines?select=categorie,marque,modele,notice_pdf,fiche_technique_pdf,statut,slug&slug=eq." + encodeURIComponent(slug) + "&limit=1"
      );
      return data[0] || null;
    }

    function renderList(items) {
  document.getElementById("title").textContent = "Liste des mod√®les";

  const all = Array.isArray(items) ? items : [];

  // Options cat√©gories
  const categories = uniqueSorted(all.map(x => (x.categorie || "").trim()));

  // UI
  contentEl.innerHTML = `
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end">
      <div style="flex:1;min-width:220px">
        <label style="display:block;font-size:12px;color:#666;font-weight:800;margin-bottom:6px">Recherche (marque / mod√®le)</label>
        <input id="q" placeholder="ex: bosch, s√©rie 6, WAT..." 
               style="width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);outline:none" />
      </div>

      <div style="min-width:200px">
        <label style="display:block;font-size:12px;color:#666;font-weight:800;margin-bottom:6px">Cat√©gorie</label>
        <select id="cat"
                style="width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#fff">
          <option value="">Toutes</option>
          ${categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")}
        </select>
      </div>

      <div style="min-width:220px">
        <label style="display:block;font-size:12px;color:#666;font-weight:800;margin-bottom:6px">Tri</label>
        <select id="sort"
                style="width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#fff">
          <option value="brand_model">Marque A‚ÜíZ, Mod√®le A‚ÜíZ</option>
          <option value="model_brand">Mod√®le A‚ÜíZ, Marque A‚ÜíZ</option>
          <option value="category_brand_model">Cat√©gorie, Marque, Mod√®le</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;color:#555">
      <span id="count"></span>
    </div>

    <div id="list" style="margin-top:12px;border-top:1px solid #eee"></div>
  `;

  const qEl = document.getElementById("q");
  const catEl = document.getElementById("cat");
  const sortEl = document.getElementById("sort");
  const listEl = document.getElementById("list");
  const countEl = document.getElementById("count");

  function sortItems(arr, mode) {
    const coll = (a, b) => a.localeCompare(b, "fr", { sensitivity: "base" });

    const get = (it, key) => (it[key] || "").toString().trim();

    const byBrandModel = (a,b) => coll(get(a,"marque"), get(b,"marque")) || coll(get(a,"modele"), get(b,"modele"));
    const byModelBrand = (a,b) => coll(get(a,"modele"), get(b,"modele")) || coll(get(a,"marque"), get(b,"marque"));
    const byCatBrandModel = (a,b) => coll(get(a,"categorie"), get(b,"categorie")) || byBrandModel(a,b);

    const copy = arr.slice();
    if (mode === "model_brand") copy.sort(byModelBrand);
    else if (mode === "category_brand_model") copy.sort(byCatBrandModel);
    else copy.sort(byBrandModel);
    return copy;
  }

  function renderRows(arr) {
    if (!arr.length) {
      listEl.innerHTML = `<p style="margin:14px 0">Aucun r√©sultat.</p>`;
      countEl.textContent = "0 mod√®le";
      return;
    }

    countEl.textContent = `${arr.length} mod√®le${arr.length > 1 ? "s" : ""}`;

    listEl.innerHTML = arr.map(it => {
      const slug = (it.slug || "").trim();
      const url = "./?slug=" + encodeURIComponent(slug);

      return `
        <div class="list-item">
          <div class="title">${escapeHtml(it.marque || "")} ‚Äì ${escapeHtml(it.modele || "")}</div>
          <div class="meta">
            ${escapeHtml(it.categorie || "")}
            ${it.statut ? " ¬∑ " + badge(it.statut) : ""}
          </div>
          <div><a href="${url}">Voir la page mod√®le</a></div>
        </div>
      `;
    }).join("");
  }

  function apply() {
    const q = normalizeText(qEl.value);
    const cat = (catEl.value || "").trim();
    const sortMode = sortEl.value;

    let filtered = all;

    if (cat) {
      filtered = filtered.filter(it => (it.categorie || "").trim() === cat);
    }

    if (q) {
      filtered = filtered.filter(it => {
        const brand = normalizeText(it.marque);
        const model = normalizeText(it.modele);
        const combined = brand + " " + model;
        return combined.includes(q);
      });
    }

    filtered = sortItems(filtered, sortMode);
    renderRows(filtered);
  }

  // Events
  qEl.addEventListener("input", apply);
  catEl.addEventListener("change", apply);
  sortEl.addEventListener("change", apply);

  // Premier rendu
  apply();
}


    function renderModel(m) {
      const title = ((m.marque || "") + " ‚Äì " + (m.modele || "")).trim() || "Mod√®le";
      document.getElementById("title").textContent = title;

      const notice = m.notice_pdf || "";
      const fiche  = m.fiche_technique_pdf || "";

      contentEl.innerHTML = ''
        + '<p><a href="./">‚Üê Retour √† la liste</a></p>'
        + '<div class="card" style="margin-top:10px">'
        +   '<div class="meta">' + escapeHtml(m.categorie || "") + '</div>'
        +   '<div style="margin:10px 0">' + (m.statut ? badge(m.statut) : "") + '</div>'
        +   '<div class="row" style="margin:12px 0">'
        +     linkButton(notice, "üìÑ Notice PDF")
        +     linkButton(fiche,  "üìä Fiche technique PDF")
        +   '</div>'
        +   '<div style="margin-top:10px;color:#555;font-size:14px">'
        +     "<div><strong>Marque :</strong> " + escapeHtml(m.marque || "") + "</div>"
        +     "<div><strong>Mod√®le :</strong> " + escapeHtml(m.modele || "") + "</div>"
        +     "<div><strong>Slug :</strong> " + escapeHtml(m.slug || "") + "</div>"
        +   "</div>"
        + "</div>";
    }

    (async () => {
      try {
        const slug = (getParam("slug") || "").trim();

        if (!slug) {
          const items = await loadList();
          renderList(items);
          return;
        }

        const m = await loadOneBySlug(slug);
        if (!m) {
          document.getElementById("title").textContent = "Mod√®le introuvable";
          contentEl.innerHTML = '<p>Le mod√®le <code>' + escapeHtml(slug) + '</code> n‚Äôexiste pas.</p><p><a href="./">Retour √† la liste</a></p>';
          return;
        }

        renderModel(m);
      } catch (e) {
        const msg = (e && (e.message || String(e))) ? (e.message || String(e)) : "Erreur inconnue";
        contentEl.innerHTML =
          '<p style="color:#b00"><strong>Erreur :</strong> ' + escapeHtml(msg) + '</p>' +
          '<p>V√©rifiez : SUPABASE_URL / ANON_KEY, RLS + policy SELECT, table <code>machines</code>.</p>';
      }
    })();
  </script>
</body>
</html>
